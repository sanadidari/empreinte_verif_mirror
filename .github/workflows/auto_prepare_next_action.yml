name: Auto Prepare Next Action â€” Agent Planner

on:
  workflow_dispatch:
  schedule:
    - cron: "*/30 * * * *"  # every 30 minutes to check NEXT_ACTION
  push:
    branches:
      - main
    paths:
      - "docs/NEXT_ACTION.md"

env:
  TASKS_PATH: "docs/TASKS.md"
  NEXT_ACTION_PATH: "docs/NEXT_ACTION.md"
  PREPARE_BRANCH_PREFIX: "auto/prepare-"

jobs:
  prepare_next_action:
    name: Read NEXT_ACTION and prepare work
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout repository (full)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install tools
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq yq gettext-base

      - name: Ensure NEXT_ACTION exists
        run: |
          if [ ! -f "${{ env.NEXT_ACTION_PATH }}" ]; then
            echo "ERROR: NEXT_ACTION.md not found at ${{ env.NEXT_ACTION_PATH }}"
            exit 10
          fi

      - name: Parse NEXT_ACTION fields
        id: parse
        run: |
          # Extract machine fields from NEXT_ACTION.md (lines like 'version: 1.1' or 'status: BLOCKING')
          STATUS=$(grep -E "^status:" "${{ env.NEXT_ACTION_PATH }}" | head -n1 | sed 's/status:[[:space:]]*//I' | tr -d '\r')
          ACTION_ID=$(grep -E "^action_id:" "${{ env.NEXT_ACTION_PATH }}" | head -n1 | sed 's/action_id:[[:space:]]*//I' | tr -d '\r')
          PRIORITY=$(grep -E "^priority:" "${{ env.NEXT_ACTION_PATH }}" | head -n1 | sed 's/priority:[[:space:]]*//I' | tr -d '\r')
          echo "status=$STATUS" >> $GITHUB_OUTPUT
          echo "action_id=$ACTION_ID" >> $GITHUB_OUTPUT
          echo "priority=$PRIORITY" >> $GITHUB_OUTPUT
          echo "Parsed NEXT_ACTION -> status=${STATUS}, action_id=${ACTION_ID}, priority=${PRIORITY}"
      - name: Fail if parse incomplete
        run: |
          if [ -z "${{ steps.parse.outputs.action_id }}" ]; then
            echo "ERROR: action_id not found in NEXT_ACTION.md"
            exit 11
          fi

      - name: Block on BLOCKING status
        if: ${{ contains( steps.parse.outputs.status, 'BLOCKING' ) }}
        run: |
          echo "NEXT_ACTION status is BLOCKING â€” generating report and stopping."
          cat > docs/PREPARE_REPORT.md <<'EOF'
# PREPARE_REPORT.md â€” ACTION BLOCKED
Generated by: Auto Prepare Next Action
Reason: NEXT_ACTION status = BLOCKING

The agent detected that the NEXT_ACTION is BLOCKING. No automatic preparations or changes will be made.
Please review docs/NEXT_ACTION.md to change status to OPEN if you want automation to proceed.

EOF
          git config --local user.email "agent-bot@system.local"
          git config --local user.name "Agent Planner Bot"
          git add docs/PREPARE_REPORT.md
          git commit -m "chore: prepare_report â€” NEXT_ACTION BLOCKING (no-op)" || echo "no changes to commit"
          git push origin HEAD:refs/heads/auto/prepare-blocking || echo "push failed"
          gh issue create --title "NEXT_ACTION BLOCKING â€” Auto Prepare Report" --body "NEXT_ACTION status=BLOCKING. PREPARE_REPORT.md created."
          exit 0

      - name: Prepare branch name
        id: branch
        run: |
          SHORTSHA=$(git rev-parse --short HEAD)
          SAFE_ACTION=$(echo "${{ steps.parse.outputs.action_id }}" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9-]/-/g' | sed 's/--*/-/g' | sed 's/^-//; s/-$//')
          BRANCH="${{ env.PREPARE_BRANCH_PREFIX }}${SAFE_ACTION}-${SHORTSHA}"
          echo "branch=${BRANCH}" >> $GITHUB_OUTPUT

      - name: Create working branch
        run: |
          git checkout -b "${{ steps.branch.outputs.branch }}"

      - name: Append task to TASKS.md
        run: |
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          TASK_ID="AUTO_${{ steps.parse.outputs.action_id }}_$(date +%s)"
          cat >> "${{ env.TASKS_PATH }}" <<EOF

  - id: ${TASK_ID}
    title: "auto: ${ { steps.parse.outputs.action_id } }"
    status: PENDING
    priority: "${{ steps.parse.outputs.priority || 'HIGH' }}"
    blocking: true
    auto_execute: true
    depends_on: []
    commands:
      - "gh workflow run 'CI / CD â€” Flutter Web â†’ Vercel' --ref main"
    artifacts:
      - "vercel deployment metadata"
    owner: agent
    notes: "Automatically prepared task for action_id=${{ steps.parse.outputs.action_id }}. Generated at ${TIMESTAMP}."
EOF

      - name: Create PREPARE_REPORT.md with plan
        run: |
          cat > docs/PREPARE_REPORT.md <<EOF
# PREPARE_REPORT.md â€” Auto Prepare Plan
Generated by: Auto Prepare Next Action Workflow
Timestamp: $(date -u)

NEXT_ACTION parsed:
- action_id: ${{ steps.parse.outputs.action_id }}
- status: ${{ steps.parse.outputs.status }}
- priority: ${{ steps.parse.outputs.priority }}

Plan:
1. Create branch: ${{ steps.branch.outputs.branch }}
2. Add auto-task to docs/TASKS.md
3. Trigger CI/CD workflow via PR after creation

EOF

      - name: Stage changes
        run: |
          git config --local user.email "agent-bot@system.local"
          git config --local user.name "Agent Planner Bot"
          git add "${{ env.TASKS_PATH }}" docs/PREPARE_REPORT.md || true
          git commit -m "chore: auto-prepare for ${{ steps.parse.outputs.action_id }}" || echo "no changes to commit"

      - name: Push branch and open PR
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: auto-prepare for ${{ steps.parse.outputs.action_id }}"
          branch: ${{ steps.branch.outputs.branch }}
          title: "Auto Prepare â€” ${{ steps.parse.outputs.action_id }}"
          body: |
            Automated preparation for NEXT_ACTION `${{ steps.parse.outputs.action_id }}`.
            - PREPARE_REPORT.md created
            - TASKS.md updated with an automated task entry
          labels: automation, auto-prepare
          assignees: ''
          reviewers: ''

      - name: Final comment (issue)
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            github.rest.issues.createComment({
              ...context.repo,
              issue_number: context.issue.number || 1,
              body: `ðŸ¤– Auto Prepare completed. PR created for branch: ${{ steps.branch.outputs.branch }}. Check docs/PREPARE_REPORT.md and docs/TASKS.md.`
            })
