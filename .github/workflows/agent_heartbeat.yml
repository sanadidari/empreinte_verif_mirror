name: Agent Heartbeat â€” Auto Diagnostic System

on:
  schedule:
    - cron: "0 * * * *"   # Every hour
  workflow_dispatch:

env:
  DOMAIN: "https://qrpruf.sanadidari.com"

jobs:
  heartbeat:
    name: Global Diagnostic
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Start heartbeat
        run: |
          echo "=== AGENT HEARTBEAT START ==="
          date

      - name: Checkout codebase
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      ##################################################################
      # 1) Verify critical documentation files
      ##################################################################
      - name: Check documentation presence
        run: |
          REQUIRED_FILES=(
            "docs/AGENT_START.md"
            "docs/DOCS_MANIFEST.yaml"
            "docs/NEXT_ACTION.md"
            "docs/DOCS_SCAN_INSTRUCTIONS.md"
            "docs/STATE_PROJECT.md"
          )
          for FILE in "${REQUIRED_FILES[@]}"; do
            if [ ! -f "$FILE" ]; then
              echo "ERROR: Missing critical doc file: $FILE"
              exit 10
            fi
          done
          echo "âœ” Documentation verified."

      ##################################################################
      # 2) Validate manifest file format
      ##################################################################
      - name: Validate DOCS_MANIFEST.yaml format
        run: |
          if ! grep -q "manifest_version" docs/DOCS_MANIFEST.yaml; then
            echo "ERROR: DOCS_MANIFEST.yaml invalid."
            exit 11
          fi
          echo "âœ” Manifest structure OK."

      ##################################################################
      # 3) Verify project structure integrity
      ##################################################################
      - name: Check Flutter project structure
        run: |
          FILES=(
            "pubspec.yaml"
            "lib"
            "web"
            ".github/workflows"
          )
          for PATH in "${FILES[@]}"; do
            if [ ! -e "$PATH" ]; then
              echo "ERROR: Missing required path: $PATH"
              exit 12
            fi
          done
          echo "âœ” Project structure OK."

      ##################################################################
      # 4) Check Vercel deployment availability
      ##################################################################
      - name: Check production endpoint
        run: |
          STATUS=$(curl -s -o resp.html -w "%{http_code}" $DOMAIN)
          echo "Status: $STATUS"
          if [ "$STATUS" != "200" ]; then
            echo "ERROR: Production endpoint offline."
            exit 13
          fi
          echo "âœ” Production reachable."

      ##################################################################
      # 5) Summarize workflow status
      ##################################################################
      - name: Fetch last workflow runs
        run: |
          echo "Fetching workflow states..."
          curl -s \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/${{ github.repository }}/actions/runs \
            > workflows.json

          echo "âœ” Workflows info collected."

      ##################################################################
      # 6) Upload all diagnostics as artifact
      ##################################################################
      - name: Upload heartbeat logs
        uses: actions/upload-artifact@v4
        with:
          name: agent-heartbeat-report
          path: |
            resp.html
            workflows.json
            docs/AGENT_START.md
            docs/DOCS_MANIFEST.yaml
            docs/NEXT_ACTION.md

      ##################################################################
      # 7) Publish summary to GitHub
      ##################################################################
      - name: Heartbeat summary comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            github.rest.issues.createComment({
              ...context.repo,
              issue_number: context.issue.number || 1,
              body: `
### ðŸ’“ Agent Heartbeat â€” System Diagnostic

âœ” Documentation OK  
âœ” Manifest OK  
âœ” Project structure OK  
âœ” Production reachable  
âœ” Workflow data collected  

Logs attached as artifacts.  
Next heartbeat in 1 hour.  
`
            })
