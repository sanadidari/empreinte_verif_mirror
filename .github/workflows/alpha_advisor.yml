name: ALPHA-ADVISOR â€” Predictive Advisor (Non-Acting)

on:
  schedule:
    - cron: "0 */6 * * *"   # toutes les 6h
  workflow_dispatch:

permissions:
  contents: read

env:
  RCDB: "docs/ROOT_CAUSE_DB.json"
  CORR: "docs/ROOT_CAUSE_CORRELATIONS.json"
  SUP: "docs/SUPERVISOR_REPORT.md"
  OUT_DIR: "/tmp/alpha_advisor"

jobs:
  advise:
    name: Run Alpha-Advisor (analysis + recommendations)
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository (read-only)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r tools/ai_requirements.txt || true

      - name: Prepare output dir
        run: |
          rm -rf $OUT_DIR || true
          mkdir -p $OUT_DIR

      - name: Run Advisor
        run: |
          python tools/alpha_advisor.py \
            --rcdb "${{ env.RCDB }}" \
            --corr "${{ env.CORR }}" \
            --supervisor "${{ env.SUP }}" \
            --outdir "$OUT_DIR"

      - name: Upload advisor artifacts
        uses: actions/upload-artifact@v4
        with:
          name: alpha-advisor-report
          path: |
            $OUT_DIR/advisor_report.md
            $OUT_DIR/advisor_recommendations.json

      - name: Create GitHub issue with summary (optional)
        if: always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const root = '/tmp/alpha_advisor';
            let summary = '';
            try {
              summary = fs.readFileSync(`${root}/advisor_report.md`, 'utf8');
            } catch (e) {
              summary = 'Alpha-Advisor ran but no report found.';
            }
            await github.rest.issues.create({
              ...context.repo,
              title: `Alpha-Advisor: recommendations (${new Date().toISOString().slice(0,10)})`,
              body: summary,
              labels: ['advisor','insight']
            });
