name: Autonomous Workflow Rewriter — AWR Engine

on:
  schedule:
    - cron: "0 */12 * * *"   # Exécution toutes les 12h
  workflow_run:
    workflows:
      - "Self-Supervisor Agent — System Behavior Auditor"
      - "AI Crash Investigator — Automated Root Cause Analysis"
    types: [completed]

  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

env:
  WORKFLOW_DIR: ".github/workflows"
  RCDB: "docs/ROOT_CAUSE_DB.json"
  CORR: "docs/ROOT_CAUSE_CORRELATIONS.json"
  REPORT: "docs/SUPERVISOR_REPORT.md"

jobs:
  rewriter:
    name: Analyze & Rewrite Broken Workflows
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install requirements
        run: |
          pip install -r tools/ai_requirements.txt || true

      - name: Run Workflow Rewriter
        run: |
          python tools/workflow_rewriter.py \
            --workflows ".github/workflows" \
            --rcdb "${{ env.RCDB }}" \
            --corr "${{ env.CORR }}" \
            --report "${{ env.REPORT }}" \
            --out "rewrites"

      - name: Stage rewrites
        run: |
          if ls rewrites/*.yml 1> /dev/null 2>&1; then
            git checkout -b auto/workflow-rewrites-$(date +"%s")
            cp rewrites/*.yml .github/workflows/
            git add .github/workflows/*.yml
            git commit -m "auto: rewritten workflows via AWR Engine"
            git push origin HEAD
          else
            echo "No rewrites generated"
          fi

      - name: Create PR
        if: success()
        run: |
          if which gh > /dev/null 2>&1; then
            gh pr create \
              --title "Autonomous Workflow Rewrite" \
              --body "This PR contains rewritten workflows generated by the AWR Engine." \
              --base main || true
          fi
