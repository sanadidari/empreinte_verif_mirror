name: Self Diagnosis (v4.x Military Edition)

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *"   # every 6 hours
  push:
    branches: [ main ]

jobs:
  diagnose:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: stable

      - name: Make diagnose script executable
        run: chmod +x .github/scripts/self_diagnose.sh

      - name: Run self-diagnosis
        id: diag
        run: |
          set +e
          .github/scripts/self_diagnose.sh
          EXIT_CODE=$?
          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT
          exit 0

      - name: Upload diagnostic artifacts
        uses: actions/upload-artifact@v4
        with:
          name: diagnostics
          path: diagnostics/

      - name: Create GitHub Issue (Critical Only)
        if: steps.diag.outputs.exit_code == '2'
        uses: peter-evans/create-issue-from-file@v4
        with:
          title: "CRITICAL: Auto-Diagnosis Failure Detected"
          content-filepath: diagnostics/issue.json
          labels: critical, auto-diagnose
